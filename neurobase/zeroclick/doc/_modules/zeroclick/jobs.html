

<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>zeroclick.jobs &mdash; zeroclick  documentation</title>
    
    <link rel="stylesheet" href="../../_static/default.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../_static/doctools.js"></script>
    <link rel="top" title="zeroclick  documentation" href="../../index.html" />
    <link rel="up" title="Module code" href="../index.html" /> 
  </head>
  <body>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">zeroclick  documentation</a> &raquo;</li>
          <li><a href="../index.html" accesskey="U">Module code</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body">
            
  <h1>Source code for zeroclick.jobs</h1><div class="highlight"><pre>
<span class="sd">&#39;&#39;&#39;</span>
<span class="sd">Author: Mathew Citarella</span>
<span class="sd">Version 1.1</span>
<span class="sd">10/24/12</span>

<span class="sd">jobs.py: Holds classes and methods for creating and manipulating zeroclick jobs</span>
<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">from</span> <span class="nn">alignment.io</span> <span class="kn">import</span> <span class="n">Reader</span>
<span class="kn">from</span> <span class="nn">files.sequences</span> <span class="kn">import</span> <span class="n">Utils</span>
<span class="kn">from</span> <span class="nn">multiprocessing</span> <span class="kn">import</span> <span class="n">Process</span>
<span class="kn">from</span> <span class="nn">zeroclick.file_io</span> <span class="kn">import</span> <span class="n">AlignmentParser</span><span class="p">,</span> <span class="n">FileExtensions</span><span class="p">,</span> <span class="n">translateSequenceFile</span><span class="p">,</span> <span class="n">make_record</span><span class="p">,</span> <span class="n">sha1_file</span>
<span class="kn">from</span> <span class="nn">zeroclick</span> <span class="kn">import</span> <span class="n">settings</span><span class="p">,</span> <span class="n">netutils</span><span class="p">,</span> <span class="n">utility</span><span class="p">,</span> <span class="n">file_io</span>
<span class="kn">from</span> <span class="nn">utility</span> <span class="kn">import</span> <span class="n">convert_if_int</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">hashlib</span>
<span class="kn">import</span> <span class="nn">imaplib</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">redis</span>
<span class="kn">import</span> <span class="nn">shutil</span>
<span class="kn">import</span> <span class="nn">ssl</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">generateSplitFilename</span><span class="p">(</span><span class="nb">file</span><span class="p">,</span> <span class="n">index</span><span class="p">,</span> <span class="n">ext</span><span class="p">):</span>
<div class="viewcode-block" id="generateSplitFilename"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.generateSplitFilename">[docs]</a>    <span class="k">return</span> <span class="nb">file</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">index</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>


<span class="k">def</span> <span class="nf">getInputSize</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span></div>
<div class="viewcode-block" id="getInputSize"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.getInputSize">[docs]</a>    <span class="nb">file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">infile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">infile</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.fasta&#39;</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.fa&#39;</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span> <span class="ow">in</span> <span class="n">l</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.fastq&#39;</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">file</span><span class="p">:</span>
            <span class="n">lc</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span><span class="n">lc</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">return</span> <span class="n">count</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">i</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">infile</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">return</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>


<span class="k">def</span> <span class="nf">getJobname</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span></div>
<div class="viewcode-block" id="getJobname"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.getJobname">[docs]</a>    <span class="k">global</span> <span class="n">session</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">jn_mapping</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;jn_mapping&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">pn_mapping</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;pn_mapping&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">q</span> <span class="o">=</span> <span class="n">jn_mapping</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pn_mapping</span><span class="p">,</span> <span class="n">jn_mapping</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">project_id</span><span class="o">==</span><span class="n">pn_mapping</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">project_id</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">jn_mapping</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">job_id</span><span class="o">==</span><span class="n">jid</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">q</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">project_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">job_type</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">getJobName</span><span class="p">(</span><span class="n">jid</span><span class="p">,</span> <span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">getProjectName</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span></div>
<div class="viewcode-block" id="getProjectName"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.getProjectName">[docs]</a>    <span class="k">global</span> <span class="n">session</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pn_mapping</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;pn_mapping&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">pn_mapping</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">pn_mapping</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">project_id</span><span class="o">==</span><span class="n">pid</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">row</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="n">results</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">row</span><span class="o">.</span><span class="n">project_name</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">raise</span>
        <span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">getProjectName</span><span class="p">(</span><span class="n">pid</span><span class="p">,</span> <span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">make_blast_index</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">db_type</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="make_blast_index"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.make_blast_index">[docs]</a>    <span class="k">if</span><span class="p">(</span><span class="n">db_type</span> <span class="o">==</span> <span class="s">&quot;NT&quot;</span><span class="p">):</span>
        <span class="n">t_string</span> <span class="o">=</span> <span class="s">&quot;nucl&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">t_string</span> <span class="o">=</span> <span class="s">&quot;prot&quot;</span>

    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;makeblastdb -in &quot;</span> <span class="o">+</span> <span class="n">db_path</span> <span class="o">+</span> <span class="s">&quot; -dbtype &quot;</span> <span class="o">+</span> <span class="n">t_string</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">blocking</span><span class="p">):</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">make_bowtie_index</span><span class="p">(</span><span class="n">db_path</span><span class="p">,</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span></div>
<div class="viewcode-block" id="make_bowtie_index"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.make_bowtie_index">[docs]</a>    <span class="k">print</span><span class="p">((</span><span class="s">&quot;bowtie-build &quot;</span> <span class="o">+</span> <span class="n">db_path</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">out_name</span><span class="p">))</span>
    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;bowtie-build &quot;</span> <span class="o">+</span> <span class="n">db_path</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">out_name</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">blocking</span><span class="p">):</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">makeRemoteDirectory</span><span class="p">(</span><span class="n">dirName</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span></div>
<div class="viewcode-block" id="makeRemoteDirectory"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.makeRemoteDirectory">[docs]</a>    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s">&quot;mkdir &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">dirName</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">next_split_file</span><span class="p">(</span><span class="n">base_name</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">current_num</span><span class="p">):</span></div>
<div class="viewcode-block" id="next_split_file"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.next_split_file">[docs]</a>    <span class="n">new_count</span> <span class="o">=</span> <span class="n">current_num</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">base_name</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">new_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">new_name</span><span class="p">,</span> <span class="n">new_count</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">parseResources</span><span class="p">(</span><span class="n">resourceString</span><span class="p">):</span></div>
<div class="viewcode-block" id="parseResources"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.parseResources">[docs]</a>    <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resourceString</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{(</span><span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">],</span> <span class="n">convert_if_int</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;:&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]))</span> <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">resourceString</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;,&quot;</span><span class="p">)}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

<span class="k">def</span> <span class="nf">splitInput</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">processingUnits</span><span class="p">):</span></div>
<div class="viewcode-block" id="splitInput"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.splitInput">[docs]</a>    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">if</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.fasta&#39;</span> <span class="ow">or</span> <span class="n">ext</span> <span class="o">==</span><span class="s">&#39;.fa&#39;</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">split_fasta</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">processingUnits</span><span class="p">)</span>
    <span class="k">elif</span><span class="p">(</span><span class="n">ext</span> <span class="o">==</span> <span class="s">&#39;.fastq&#39;</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">split_fastq</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">processingUnits</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">ret</span>

<span class="k">def</span> <span class="nf">split_fastq</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">processingUnits</span><span class="p">):</span></div>
<div class="viewcode-block" id="split_fastq"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.split_fastq">[docs]</a>    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">d</span><span class="p">,</span> <span class="n">fname</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="n">base</span><span class="p">,</span> <span class="n">ext</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">fname</span><span class="p">)</span>
    <span class="n">seqs_per</span> <span class="o">=</span> <span class="p">(</span><span class="n">getInputSize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">/</span><span class="n">processingUnits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">seq_count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">file_count</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">base</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job_type</span>
    <span class="n">curfile</span> <span class="o">=</span> <span class="n">base</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_count</span><span class="p">)</span> <span class="o">+</span> <span class="n">ext</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">curfile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curfile</span><span class="p">)</span>
    <span class="n">lc</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">lc</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">lc</span> <span class="o">%</span> <span class="mi">4</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">seq_count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">if</span><span class="p">(</span><span class="n">seq_count</span> <span class="o">==</span> <span class="n">seqs_per</span><span class="p">):</span>
            <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="n">curfile</span><span class="p">,</span> <span class="n">file_count</span> <span class="o">=</span> <span class="n">next_split_file</span><span class="p">(</span><span class="n">base</span><span class="p">,</span> <span class="n">ext</span><span class="p">,</span> <span class="n">file_count</span><span class="p">)</span>
            <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">d</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">curfile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
            <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curfile</span><span class="p">)</span>
            <span class="n">seq_count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">filenames</span>


<span class="k">def</span> <span class="nf">split_fasta</span><span class="p">(</span><span class="n">queryFile</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">processingUnits</span><span class="p">):</span></div>
<div class="viewcode-block" id="split_fasta"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.split_fasta">[docs]</a>    <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">queryFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">directory</span><span class="p">,</span> <span class="nb">file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">queryFile</span><span class="p">)</span>
    <span class="n">fileBase</span><span class="p">,</span> <span class="n">fileExt</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="nb">file</span><span class="p">)</span>
    <span class="n">seqsPerFile</span> <span class="o">=</span> <span class="p">(</span><span class="n">getInputSize</span><span class="p">(</span><span class="n">queryFile</span><span class="p">)</span><span class="o">/</span><span class="n">processingUnits</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="n">seqCounter</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">fileCounter</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">filenames</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">fileBase</span> <span class="o">+=</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="n">job_type</span>
    <span class="c">#if(directory == &#39;&#39;):</span>
        <span class="c">#curFile = fileBase + &quot;_&quot; + str(fileCounter) + fileExt</span>
    <span class="c">#else:</span>
        <span class="c">#curFile = directory + &quot;/&quot; + fileBase + &quot;_&quot; + str(fileCounter) + fileExt</span>
    <span class="n">curFile</span> <span class="o">=</span> <span class="n">fileBase</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileCounter</span><span class="p">)</span> <span class="o">+</span> <span class="n">fileExt</span>
    <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
    <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
            <span class="n">seqCounter</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">if</span><span class="p">(</span><span class="n">seqCounter</span> <span class="o">&gt;</span> <span class="nb">int</span><span class="p">(</span><span class="n">seqsPerFile</span><span class="p">)):</span>
                <span class="c">#close the open partition file</span>
                <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="c">#increment the file counter and open the next file</span>
                <span class="n">fileCounter</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c">#if(directory == &#39;&#39;):</span>
                <span class="c">#    curFile = fileBase + &quot;_&quot; + str(fileCounter) + fileExt</span>
                <span class="c">#else:</span>
                <span class="c">#    curFile = directory + &quot;/&quot; + fileBase + &quot;_&quot; + str(fileCounter) + fileExt</span>
                <span class="n">curFile</span> <span class="o">=</span> <span class="n">fileBase</span> <span class="o">+</span> <span class="s">&quot;_&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">fileCounter</span><span class="p">)</span> <span class="o">+</span> <span class="n">fileExt</span>
                <span class="n">fw</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">directory</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">curFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
                <span class="n">filenames</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">curFile</span><span class="p">)</span>
                <span class="c">#reset the seqCounter to 1</span>
                <span class="n">seqCounter</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">fw</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

    <span class="n">fw</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">filenames</span>


<span class="k">class</span> <span class="nc">Arguments</span><span class="p">:</span></div>
<div class="viewcode-block" id="Arguments"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Arguments">[docs]</a>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">arg_string</span><span class="p">,</span> <span class="n">job_type</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">has_required</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">=</span> <span class="n">arg_string</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="o">=</span> <span class="n">job_type</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mark_required</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="Arguments.parse"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Arguments.parse">[docs]</a>
        <span class="k">class</span> <span class="nc">ParseState</span><span class="p">:</span>

            <span class="n">SEEK</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">SINGLE_DASH</span> <span class="o">=</span> <span class="mi">2</span>
            <span class="n">DOUBLE_DASH</span> <span class="o">=</span> <span class="mi">3</span>
            <span class="n">ARG_NAME</span> <span class="o">=</span> <span class="mi">4</span>
            <span class="n">VALUE</span> <span class="o">=</span> <span class="mi">5</span>
            <span class="n">AFTER_ARG</span> <span class="o">=</span> <span class="mi">6</span>
            <span class="n">POSITIONAL</span> <span class="o">=</span> <span class="mi">7</span>

        <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
        <span class="n">arg_name</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">value</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="n">quote_open</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">has_required_value</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">for</span> <span class="n">char</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">arg_string</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SINGLE_DASH</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">POSITIONAL</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">char</span>
                    <span class="n">quote_open</span> <span class="o">=</span> <span class="bp">True</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">!=</span> <span class="s">&quot; &quot;</span><span class="p">):</span>
                    <span class="n">value</span> <span class="o">=</span> <span class="n">char</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">POSITIONAL</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">POSITIONAL</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="n">quote_open</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote_open</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">quote_open</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">+=</span> <span class="n">char</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
                        <span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_names</span><span class="p">()</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">char</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SINGLE_DASH</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">DOUBLE_DASH</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">ARG_NAME</span>
                    <span class="n">arg_name</span> <span class="o">+=</span> <span class="n">char</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">DOUBLE_DASH</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">ARG_NAME</span>
                    <span class="n">arg_name</span> <span class="o">+=</span> <span class="n">char</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">ARG_NAME</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="n">arg_name</span> <span class="o">=</span> <span class="n">arg_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;-&quot;</span><span class="p">,</span> <span class="s">&quot;_&quot;</span><span class="p">)</span>
                    <span class="n">has_required_value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_value_required</span><span class="p">(</span><span class="n">arg_name</span><span class="p">)</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">AFTER_ARG</span>

                <span class="k">else</span><span class="p">:</span>
                    <span class="c">#keep parsing until there&#39;s a space</span>
                    <span class="n">arg_name</span> <span class="o">+=</span> <span class="n">char</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">AFTER_ARG</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_names</span><span class="p">()</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;-&#39;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
                    <span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_names</span><span class="p">()</span>
                    <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SINGLE_DASH</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">has_required_value</span><span class="p">):</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                            <span class="n">quote_open</span> <span class="o">=</span> <span class="bp">True</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">VALUE</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">char</span>
                            <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">VALUE</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">POSITIONAL</span>
                        <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                            <span class="n">quote_open</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">value</span> <span class="o">=</span> <span class="n">char</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">VALUE</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39; &#39;</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">quote_open</span><span class="p">):</span>
                        <span class="n">value</span> <span class="o">+=</span> <span class="n">char</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>
                        <span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_reset_names</span><span class="p">()</span>
                        <span class="n">state</span> <span class="o">=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">SEEK</span>
                <span class="k">elif</span><span class="p">(</span><span class="n">char</span> <span class="o">==</span> <span class="s">&#39;&quot;&#39;</span><span class="p">):</span>
                    <span class="n">quote_open</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">quote_open</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">value</span> <span class="o">+=</span> <span class="n">char</span>

        <span class="k">if</span><span class="p">(</span><span class="n">state</span> <span class="o">==</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">POSITIONAL</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">state</span> <span class="o">!=</span> <span class="n">ParseState</span><span class="o">.</span><span class="n">VALUE</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_setattr</span><span class="p">(</span><span class="n">arg_name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_mark_required</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="k">return</span>

        <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;proc_options&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">),</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&#39;pipe_options&#39;</span><span class="p">,</span> <span class="n">session</span><span class="p">)]</span>
        <span class="k">for</span> <span class="n">table</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">table</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">job_type</span><span class="o">==</span><span class="bp">self</span><span class="o">.</span><span class="n">job_type</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
                <span class="k">if</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">arg_required</span> <span class="o">==</span> <span class="s">&quot;Y&quot;</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mark_value_required</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_reset_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">==</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">mark_value_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
<div class="viewcode-block" id="Arguments.mark_value_required"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Arguments.mark_value_required">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">has_required</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">is_value_required</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span></div>
<div class="viewcode-block" id="Arguments.is_value_required"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Arguments.is_value_required">[docs]</a>        <span class="k">if</span><span class="p">(</span><span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">has_required</span><span class="p">):</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">print_me</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Arguments.print_me"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Arguments.print_me">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">positional</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">__dict__</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">print</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">key</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">value</span><span class="p">))</span>

<span class="k">class</span> <span class="nc">Resources</span><span class="p">:</span></div></div>
<div class="viewcode-block" id="Resources"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Resources">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">totals</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">addResource</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resType</span><span class="p">,</span> <span class="n">resMaxAmt</span><span class="p">):</span>
<div class="viewcode-block" id="Resources.addResource"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Resources.addResource">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">[</span><span class="n">resType</span><span class="p">]</span> <span class="o">=</span> <span class="n">resMaxAmt</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">resType</span><span class="p">]</span> <span class="o">=</span> <span class="n">resMaxAmt</span><span class="p">;</span>

    <span class="k">def</span> <span class="nf">giveTo</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span></div>
<div class="viewcode-block" id="Resources.giveTo"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Resources.giveTo">[docs]</a>
        <span class="n">enoughResources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">hasEnoughFree</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="n">enoughResources</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">-=</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


        <span class="k">return</span> <span class="n">enoughResources</span>

    <span class="k">def</span> <span class="nf">hasEnoughFree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span></div>
<div class="viewcode-block" id="Resources.hasEnoughFree"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Resources.hasEnoughFree">[docs]</a>        <span class="n">enough</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">resources</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span><span class="p">(</span><span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">):</span>
                <span class="k">if</span><span class="p">(</span><span class="n">value</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                    <span class="n">enough</span> <span class="o">=</span> <span class="bp">False</span>

        <span class="k">return</span> <span class="n">enough</span>

    <span class="k">def</span> <span class="nf">takeFrom</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span></div>
<div class="viewcode-block" id="Resources.takeFrom"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Resources.takeFrom">[docs]</a>        <span class="n">resources</span> <span class="o">=</span> <span class="p">[</span><span class="n">key</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">iterkeys</span><span class="p">()</span> <span class="k">if</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">resources</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">[</span><span class="n">key</span><span class="p">]):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">job</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">free</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">totals</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>


<span class="k">class</span> <span class="nc">Locations</span><span class="p">:</span></div></div>
<div class="viewcode-block" id="Locations"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Locations">[docs]</a>
    <span class="n">LOCAL</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">HPC</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">JobState</span><span class="p">:</span></div>
<div class="viewcode-block" id="JobState"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.JobState">[docs]</a>
    <span class="n">RUNNING</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">FINISHED</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">ERROR</span> <span class="o">=</span> <span class="mi">2</span>


<span class="k">class</span> <span class="nc">Job</span><span class="p">:</span></div>
<div class="viewcode-block" id="Job"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">process_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobType</span> <span class="o">=</span> <span class="n">t</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pid</span> <span class="o">=</span> <span class="n">pid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jid</span> <span class="o">=</span> <span class="n">jid</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">=</span> <span class="n">getProjectName</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span> <span class="o">=</span> <span class="n">getJobname</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">Locations</span><span class="o">.</span><span class="n">LOCAL</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="n">executable</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">runName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">generateRunName</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">parseResources</span><span class="p">(</span><span class="n">resources</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

        <span class="c">#can we set the input file automatically?</span>
        <span class="k">if</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">inputExtensions</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">forInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">)</span>

        <span class="c">#same for the output file</span>
        <span class="n">outModifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span> <span class="o">+</span> <span class="s">&quot;.txt&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">t</span> <span class="ow">in</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">outputExtensions</span><span class="p">):</span>
            <span class="n">outModifier</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">forOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="n">outModifier</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span> <span class="o">=</span> <span class="n">Arguments</span><span class="p">(</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">Arguments</span><span class="p">(</span><span class="n">process_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_handle_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
                        <span class="c">#        self.input_file = self.pipeline_args.input_file</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;input_file&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">special_run</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;input_file&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;output_file&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_inputExists</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">);</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_executeCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_output</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">capture_output</span><span class="p">):</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">blocking</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_removeWorkingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">_prepare_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">input_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">input_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span>
        <span class="k">if</span><span class="p">(</span><span class="n">output_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>

        <span class="c">#get the list of possible process options</span>
        <span class="n">proc_options</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;proc_options&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">proc_opt_res</span> <span class="o">=</span> <span class="n">proc_options</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">proc_options</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">job_type</span><span class="o">==</span><span class="n">job_type</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="c">#retrive how this command is run</span>
        <span class="n">execs</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;executables&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">command_res</span> <span class="o">=</span> <span class="n">execs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">execs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">exec_name</span><span class="o">==</span><span class="n">prog</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">command_res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">executable</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">command</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">args</span>

        <span class="c">#set the input and output, if necessary</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;input&gt;&quot;</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;output&gt;&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="c">#check if we need to replace the processors per node in this command</span>
        <span class="k">if</span><span class="p">(</span><span class="s">&#39;ppn&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;num_threads&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]))</span>

        <span class="c">#set user-supplied flags</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">proc_opt_res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">repl_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">default_value</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span><span class="p">)):</span>
                <span class="n">repl_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">repl_val</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span><span class="p">(</span><span class="n">args_only</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">executable</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">args</span>

    <span class="k">def</span> <span class="nf">_setResources</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">resourceString</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parseResources</span><span class="p">(</span><span class="n">resourceString</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="Job.check"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.check">[docs]</a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="n">exit_stat</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">poll</span><span class="p">()</span>
            <span class="k">if</span><span class="p">(</span><span class="n">exit_stat</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">exit_stat</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error no: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">exit_stat</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; while running &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">FINISHED</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span> <span class="k">pass</span></div>
<div class="viewcode-block" id="Job.cleanup"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.cleanup">[docs]</a>
    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Job.complete"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.complete">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">generateRunName</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Job.generateRunName"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.generateRunName">[docs]</a>        <span class="n">t</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">day</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">second</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">replace_in_proc_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">repl</span><span class="p">):</span></div>
<div class="viewcode-block" id="Job.replace_in_proc_args"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.replace_in_proc_args">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">placeholder</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span> <span class="p">,</span> <span class="n">repl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">replace_in_pipe_args</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">placeholder</span><span class="p">,</span> <span class="n">repl</span><span class="p">):</span></div>
<div class="viewcode-block" id="Job.replace_in_pipe_args"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.replace_in_pipe_args">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">arg_string</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">placeholder</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span> <span class="p">,</span> <span class="n">repl</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Job.upload"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Job.upload">[docs]</a>        <span class="n">session</span><span class="o">.</span><span class="n">activateConnection</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
           <span class="s">&quot;select project_id from queue where ((project_id = ?) and (job_type = &#39;upload&#39;))&quot;</span><span class="p">,(</span><span class="bp">self</span><span class="o">.</span><span class="n">pid</span><span class="p">))</span>
        <span class="n">xxx</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">xxx</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span> <span class="c"># then we don&#39;t upload this job</span>
            <span class="k">return</span>
        <span class="n">local_dir</span><span class="p">,</span> <span class="n">file_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">local_dir</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">local_dir</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
        <span class="n">pickle_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;_checksum.pickle&quot;</span>
        <span class="n">pickle_path</span> <span class="o">=</span> <span class="n">local_dir</span> <span class="o">+</span> <span class="n">pickle_file</span>
        <span class="n">local_file</span> <span class="o">=</span> <span class="n">local_dir</span> <span class="o">+</span> <span class="n">file_name</span>
        <span class="n">remote_dir</span> <span class="o">=</span>  <span class="n">settings</span><span class="o">.</span><span class="n">CYGWIN_NEUROBASE_STORAGE</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="n">remote_file</span> <span class="o">=</span> <span class="n">remote_dir</span> <span class="o">+</span> <span class="n">file_name</span>
        <span class="k">print</span> <span class="s">&quot;starting upload of: &quot;</span><span class="p">,</span> <span class="n">file_name</span>
        <span class="n">sshConn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="k">while</span> <span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">sshConn</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">SSHConnection</span><span class="p">(</span><span class="s">&#39;128.227.123.35&#39;</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="s">&#39;Administrator&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s">&#39;ds2008&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">2122</span><span class="p">)</span>
                <span class="k">print</span> <span class="s">&quot;connected to 128.227.123.35&quot;</span>
                <span class="k">break</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error creating SSHConnection, sleeping for two minutes and trying again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
                <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
                <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="k">raise</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;mkdir &quot;</span> <span class="o">+</span> <span class="n">remote_dir</span>
        <span class="n">sshConn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;chmod -R a+rwx &quot;</span> <span class="o">+</span> <span class="n">remote_dir</span>
        <span class="n">sshConn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">sshConn</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local_file</span><span class="p">,</span> <span class="n">remote_file</span><span class="p">)</span>
        <span class="n">file_hash</span> <span class="o">=</span> <span class="p">{</span><span class="n">local_file</span><span class="p">:</span> <span class="n">sha1_file</span><span class="p">(</span><span class="n">local_file</span><span class="p">)}</span>
        <span class="c">#check if the checksum pickle exists</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">)):</span>
            <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">chk_hash</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
            <span class="n">chk_hash</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">]</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">file_hash</span><span class="p">)</span>
                <span class="c">#chk_hash[self.jobType] = (local_file, sha1_file(local_file))</span>
            <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">chk_hash</span> <span class="o">=</span> <span class="p">{</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">:</span> <span class="n">file_hash</span><span class="p">}</span>

        <span class="c">#open file for de-pickling</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">chk_hash</span><span class="p">,</span> <span class="n">fh</span><span class="p">)</span>
        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="c">#move the de-pickled file</span>
        <span class="n">sshConn</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">pickle_path</span><span class="p">,</span> <span class="n">remote_dir</span> <span class="o">+</span> <span class="n">pickle_file</span><span class="p">)</span>
        <span class="n">sshConn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">LocalJob</span><span class="p">(</span><span class="n">Job</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="LocalJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.LocalJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">process_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="n">Job</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="o">=</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="o">=</span><span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_args</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="LocalJob.check"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.LocalJob.check">[docs]</a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">is_alive</span><span class="p">()):</span>
                <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span>
        <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">FINISHED</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="LocalJob.stop"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.LocalJob.stop">[docs]</a>        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="n">p</span><span class="o">.</span><span class="n">terminate</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">AdapterTrimJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="AdapterTrimJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AdapterTrimJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">AdapterTrimProcess</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="AdapterTrimJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AdapterTrimJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting AdapterTrimJob: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AssemblyJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="AssemblyJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AssemblyJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">AssemblyProcess</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">20</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="AssemblyJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AssemblyJob.start">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;trinity&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;mira&quot;</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;miranewbler&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">assembler</span>
            <span class="n">paired_end</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;paired_end&quot;</span><span class="p">)):</span>
                <span class="n">paired_end</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting AssemblyJob &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">)</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting the process!&quot;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">paired_end</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;cpu&#39;</span><span class="p">])</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BlastAssociationJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="BlastAssociationJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastAssociationJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="s">&quot;cpu:1&quot;</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s">&quot;kegg&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">KEGGProcess</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="s">&quot;go&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">GOProcess</span>

    <span class="k">def</span> <span class="nf">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="BlastAssociationJob.upload"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastAssociationJob.upload">[docs]</a>        <span class="n">Job</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span> <span class="o">==</span> <span class="s">&quot;go&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;_gocats.txt&quot;</span>
            <span class="n">Job</span><span class="o">.</span><span class="n">upload</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="BlastAssociationJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastAssociationJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting BlastAssociationJob &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputExists</span><span class="p">()):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting the process!&quot;</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
            <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PreAssemblyJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="PreAssemblyJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PreAssemblyJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">PreAssemblyProcess</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="PreAssemblyJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PreAssemblyJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="n">paired_end</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;paired_end&quot;</span><span class="p">)):</span>
            <span class="n">paired_end</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting PreAssemblyJob &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting the process!&quot;</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">paired_end</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">PantherJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="PantherJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PantherJob">[docs]</a>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">PantherProcess</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="PantherJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PantherJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting PantherJob &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_inputExists</span><span class="p">()):</span>
           <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting the process!&quot;</span><span class="p">)</span>
           <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,)</span>
           <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
           <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QualityTrimJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="QualityTrimJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QualityTrimJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">QualityTrimProcess</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="QualityTrimJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QualityTrimJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting QualityTrimJob&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ReadNormJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="ReadNormJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.ReadNormJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jtype</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span> <span class="o">=</span> <span class="n">ReadNormProcess</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="ReadNormJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.ReadNormJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting ReadNormJob&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constructor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">UploadJob</span><span class="p">(</span><span class="n">LocalJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="UploadJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.UploadJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">):</span>
        <span class="n">LocalJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="UploadJob.complete"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.UploadJob.complete">[docs]</a>        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="UploadJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.UploadJob.start">[docs]</a>        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PipeProcess</span><span class="p">(</span><span class="n">Process</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="PipeProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PipeProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_executeCmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd</span><span class="p">,</span> <span class="n">blocking</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">capture_out</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">redirect</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span><span class="p">(</span><span class="n">capture_out</span><span class="p">):</span>
            <span class="n">redirect</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span>

        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">redirect</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">redirect</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">blocking</span><span class="p">):</span>
            <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">p</span>

    <span class="k">def</span> <span class="nf">_prepare_cmd</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prog</span><span class="p">,</span> <span class="n">job_type</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">args_only</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
        <span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>
        <span class="k">if</span><span class="p">(</span><span class="n">input_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">input_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span>
        <span class="k">if</span><span class="p">(</span><span class="n">output_file</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">output_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>

        <span class="c">#get the list of possible process options</span>
        <span class="n">proc_options</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;proc_options&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">proc_opt_res</span> <span class="o">=</span> <span class="n">proc_options</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">proc_options</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">job_type</span><span class="o">==</span><span class="n">job_type</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

        <span class="c">#retrive how this command is run</span>
        <span class="n">execs</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">getTableObject</span><span class="p">(</span><span class="s">&quot;executables&quot;</span><span class="p">,</span> <span class="n">session</span><span class="p">)</span>
        <span class="n">command_res</span> <span class="o">=</span> <span class="n">execs</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">execs</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">exec_name</span><span class="o">==</span><span class="n">prog</span><span class="p">)</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">command_res</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>

        <span class="n">executable</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">command</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">command</span><span class="o">.</span><span class="n">args</span>

        <span class="c">#set the input and output, if necessary</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;input&gt;&quot;</span><span class="p">,</span> <span class="n">input_file</span><span class="p">)</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;output&gt;&quot;</span><span class="p">,</span> <span class="n">output_file</span><span class="p">)</span>

        <span class="c">#check if we need to replace the processors per node in this command</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s">&quot;resources&quot;</span><span class="p">)):</span>
            <span class="k">if</span><span class="p">(</span><span class="s">&#39;ppn&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">):</span>
                <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;num_threads&gt;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]))</span>

        <span class="c">#set user-supplied flags</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">proc_opt_res</span><span class="o">.</span><span class="n">fetchall</span><span class="p">():</span>
            <span class="n">repl_val</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">default_value</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span><span class="p">)):</span>
                <span class="n">repl_val</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span><span class="p">)</span>
            <span class="n">args</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;&quot;</span> <span class="o">+</span> <span class="n">row</span><span class="o">.</span><span class="n">flag</span> <span class="o">+</span> <span class="s">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">repl_val</span><span class="p">)</span>

        <span class="n">session</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="k">if</span><span class="p">(</span><span class="n">args_only</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">args</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">executable</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">args</span>



<span class="k">class</span> <span class="nc">AdapterTrimProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div>
<div class="viewcode-block" id="AdapterTrimProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AdapterTrimProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">process_args</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">process_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span> <span class="o">=</span> <span class="n">pipeline_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">trim_adapters</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<div class="viewcode-block" id="AdapterTrimProcess.trim_adapters"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AdapterTrimProcess.trim_adapters">[docs]</a>        <span class="n">session</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">make_db_session</span><span class="p">()</span>
        <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="s">&quot;.trimming.tmp&quot;</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="s">&quot;fastx_clipper&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;adaptor_trimmer&quot;</span><span class="p">)):</span>
            <span class="n">prog</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">adaptor_trimmer</span>

        <span class="c">#get the adaptors sequences</span>
        <span class="n">adapts</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">get_adapters</span><span class="p">(</span><span class="n">netutils</span><span class="o">.</span><span class="n">get_pid</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">project_name</span><span class="p">,</span> <span class="n">session</span><span class="p">),</span> <span class="n">session</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">adapt</span> <span class="ow">in</span> <span class="n">adapts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">adapter</span> <span class="o">=</span> <span class="n">adapt</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_cmd</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="s">&quot;adapter_trim&quot;</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
            <span class="c">#overwrite the original file with the trimmed file</span>
            <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="AdapterTrimProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AdapterTrimProcess.run">[docs]</a>        <span class="c">#parse the process args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;paired_end&quot;</span><span class="p">)):</span>
            <span class="c">#add the second input file</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot;.end2.fastq&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_adapters</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">AssemblyProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="AssemblyProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AssemblyProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">input_File</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">process_args</span><span class="p">,</span> <span class="n">paired_end</span><span class="p">,</span> <span class="n">assembler</span><span class="p">,</span> <span class="n">cpus</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">input_File</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">process_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paired_end</span> <span class="o">=</span> <span class="n">paired_end</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">=</span> <span class="n">assembler</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cpus</span> <span class="o">=</span> <span class="n">cpus</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="AssemblyProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.AssemblyProcess.run">[docs]</a>        <span class="n">out_dir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paired_end</span><span class="p">):</span>
          <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;trinity&quot;</span><span class="p">):</span>
            <span class="n">inputFile1</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;fasta&quot;</span>
            <span class="n">inputFile2</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;end2.fasta&quot;</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;perl &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;run_trinity.pl -in_file1 &quot;</span> <span class="o">+</span> <span class="n">inputFile1</span> <span class="o">+</span> <span class="s">&quot; -in_file2 &quot;</span> <span class="o">+</span> <span class="n">inputFile2</span> <span class="o">+</span> <span class="s">&quot; -install_dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALL_DIR</span> <span class="o">+</span> <span class="s">&quot; -cpus &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">out_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;.fasta&quot;</span>
            <span class="k">if</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;trinity&quot;</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;perl &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;run_trinity.pl -in_file1 &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot; -install_dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALL_DIR</span> <span class="o">+</span> <span class="s">&quot; -cpus &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;mira&quot;</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;python &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;assembly_pipeline.py -mira -o &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot; -cpu &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; fastq &quot;</span> <span class="o">+</span> <span class="n">out_dir</span> <span class="c"># What does the file look like? extension etc.</span>
            <span class="k">elif</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">assembler</span> <span class="o">==</span> <span class="s">&quot;miranewbler&quot;</span><span class="p">):</span>
                <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;python &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;assembly_pipeline.py -o &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;-cpu &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cpus</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; fastq &quot;</span> <span class="o">+</span> <span class="n">out_dir</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">BlastAssociationProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="BlastAssociationProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastAssociationProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">blastFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">numAssociations</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseName</span> <span class="o">=</span> <span class="n">baseName</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">home_dir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="n">baseName</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">blastFile</span> <span class="o">=</span> <span class="n">blastFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyPrefix</span> <span class="o">=</span> <span class="bp">None</span>


    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="BlastAssociationProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastAssociationProcess.run">[docs]</a>        <span class="n">rServer</span> <span class="o">=</span> <span class="n">redis</span><span class="o">.</span><span class="n">Redis</span><span class="p">(</span><span class="n">host</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_HOST</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">REDIS_PORT</span><span class="p">,</span> <span class="n">db</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">AlignmentParser</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blastFile</span><span class="p">,</span> <span class="s">&quot;hpc-blast&quot;</span><span class="p">)</span>
        <span class="n">p</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">query</span><span class="p">,</span> <span class="n">hits</span> <span class="ow">in</span> <span class="n">p</span><span class="o">.</span><span class="n">annotations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">for</span> <span class="n">hit</span> <span class="ow">in</span> <span class="n">hits</span><span class="p">:</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">hit</span><span class="o">.</span><span class="n">reference_id</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;|&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">reference</span> <span class="o">=</span> <span class="n">reference</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;.&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c">#for each hit asccesion, get all of the associated records in the db</span>
                <span class="n">records</span> <span class="o">=</span> <span class="n">rServer</span><span class="o">.</span><span class="n">lrange</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">keyPrefix</span> <span class="o">+</span> <span class="n">reference</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
                    <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">query</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="n">record</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">score</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">hit</span><span class="o">.</span><span class="n">significance</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">GOProcess</span><span class="p">(</span><span class="n">BlastAssociationProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="GOProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.GOProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">blastFile</span><span class="p">,</span> <span class="n">outPath</span><span class="p">):</span>
        <span class="n">BlastAssociationProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">blastFile</span><span class="p">,</span> <span class="n">outPath</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyPrefix</span> <span class="o">=</span> <span class="s">&quot;zero_click:goa:&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputSize</span> <span class="o">=</span> <span class="n">getInputSize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">blastFile</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="GOProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.GOProcess.run">[docs]</a>        <span class="n">BlastAssociationProcess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="c">#run two rounds of file-flattening</span>
        <span class="c">#first, flatten based on seq_id, go_term</span>
        <span class="c">#then flatten based on seq_id, limit 10 records by default (maybe allow pipeline parameter to change this?)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="s">&quot;python &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;/filetools.py  --fields seq_id:1 sp_acc:2 go_term:3 go_ref:4 comaprtment:5 gene_id:6 score:7 evalue:8:float --key-col 1 3 --flatten --filter evalue:lt:1e-04 --flatten-depth 1 &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="s">&quot;wc -l &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot;_flattened.txt&quot;</span><span class="p">,</span> <span class="n">capture_out</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
        <span class="n">num</span> <span class="o">=</span> <span class="n">convert_if_int</span><span class="p">(</span><span class="n">output</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">tmpOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot;_flattened.txt&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">num</span> <span class="o">&gt;</span> <span class="mi">200000</span><span class="p">):</span>
            <span class="c">#having more than 200000 records triggers flattening</span>
            <span class="n">p</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="s">&quot;python &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;/filetools.py  --fields seq_id:1 sp_acc:2 go_term:3 evalue:8:float --key-col 1 --flatten --flatten-depth 10 &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>  <span class="o">+</span> <span class="s">&quot;_flattened.txt&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmpOut</span><span class="p">)</span>
            <span class="n">tmpOut</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot;_flattened.txt_flattened.txt&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="s">&quot;mv &quot;</span> <span class="o">+</span> <span class="n">tmpOut</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>

        <span class="c">#run the GOAnnotator software on the annotations to get category-level summaries</span>
        <span class="c">#check if the quantification file exists for this project (it should, if not categories will lack abundance data)</span>
        <span class="n">quantFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseName</span> <span class="o">+</span> <span class="s">&quot;_quantification.txt&quot;</span>
        <span class="n">javaCmd</span> <span class="o">=</span> <span class="s">&quot;java -Xmx10g goannot8r.GOAnnotator &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseName</span> <span class="o">+</span> <span class="s">&quot; &quot;</span>  <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>
        <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">quantFile</span><span class="p">)):</span>
            <span class="n">javaCmd</span> <span class="o">+=</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">quantFile</span>

        <span class="n">javaCmd</span> <span class="o">+=</span> <span class="s">&quot; &gt; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">baseName</span> <span class="o">+</span> <span class="s">&quot;_gocats.txt&quot;</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">javaCmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">KEGGProcess</span><span class="p">(</span><span class="n">BlastAssociationProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="KEGGProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.KEGGProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">blastFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">):</span>
        <span class="n">BlastAssociationProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">baseName</span><span class="p">,</span> <span class="n">blastFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">keyPrefix</span> <span class="o">=</span> <span class="s">&quot;zero_click:koa:&quot;</span>


<span class="k">class</span> <span class="nc">PantherProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div>
<div class="viewcode-block" id="PantherProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PantherProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">input_File</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">input_File</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">process_args</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="PantherProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PantherProcess.run">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Translating fasta into proteins &amp; running panther.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">translateSequenceFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="s">&quot;fasta&quot;</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;perl &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALL_DIR</span> <span class="o">+</span> <span class="s">&quot;scripts/pantherScore.pl -V -l &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">panther_data_path</span> <span class="o">+</span> <span class="s">&quot; -D A -V -n -i &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot; -o &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>
        <span class="n">process_obj</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">process_obj</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">PfamProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="PfamProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PfamProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">seqFile</span><span class="p">,</span> <span class="n">outputFile</span><span class="p">):</span>
        <span class="n">Process</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">seqFile</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="PfamProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PfamProcess.run">[docs]</a>        <span class="c">#translate the input file</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting pfam process on: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">translated</span> <span class="o">=</span> <span class="n">translateSequenceFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="s">&quot;fasta&quot;</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">chdir</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">pfam_exec_path</span><span class="p">)</span>
        <span class="c">#run pfam</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;perl pfam_scan.pl -cpu 1 -outfile &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot; -dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">pfam_data_path</span> <span class="o">+</span> <span class="s">&quot; -fasta &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">translated</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="c">#wait for pfam to finish</span>
        <span class="n">p</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Pfam process done.&quot;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QualityTrimProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="QualityTrimProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QualityTrimProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span> <span class="o">=</span> <span class="n">pipeline_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">process_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">trim_quality</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<div class="viewcode-block" id="QualityTrimProcess.trim_quality"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QualityTrimProcess.trim_quality">[docs]</a>        <span class="n">tmp</span> <span class="o">=</span> <span class="n">f</span> <span class="o">+</span> <span class="s">&quot;.quality.tmp&quot;</span>
        <span class="n">prog</span> <span class="o">=</span> <span class="s">&quot;cutadapt&quot;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s">&quot;quality_trimmer&quot;</span><span class="p">)):</span>
            <span class="n">prog</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">quality_trimmer</span>

        <span class="n">cmd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_cmd</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="s">&quot;quality_trim&quot;</span><span class="p">,</span> <span class="n">input_file</span><span class="o">=</span><span class="n">f</span><span class="p">,</span> <span class="n">output_file</span><span class="o">=</span><span class="n">tmp</span><span class="p">)</span>
        <span class="k">print</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c">#use the trimmer to trim quality</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="c">#re-write the original file as the trimmed file</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span> <span class="n">f</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QualityTrimProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QualityTrimProcess.run">[docs]</a>        <span class="c">#parse the process args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">]</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;paired_end&quot;</span><span class="p">)):</span>
            <span class="c">#add the second input file</span>
            <span class="n">files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot;.end2.fastq&quot;</span><span class="p">)</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Trimming quality.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trim_quality</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">ReadNormProcess</span><span class="p">(</span><span class="n">PipeProcess</span><span class="p">,</span> <span class="n">Job</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="ReadNormProcess"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.ReadNormProcess">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">project_name</span><span class="p">,</span> <span class="n">input_file</span><span class="p">,</span> <span class="n">output_file</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">,</span> <span class="n">resources</span><span class="p">):</span>
        <span class="n">PipeProcess</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">project_name</span> <span class="o">=</span> <span class="n">project_name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">input_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">output_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span> <span class="o">=</span> <span class="n">pipeline_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span> <span class="o">=</span> <span class="n">process_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span> <span class="o">=</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">run_khmer</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="ReadNormProcess.run_khmer"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.ReadNormProcess.run_khmer">[docs]</a>        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">paired_end</span><span class="p">):</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;perl &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;pre_assemble.pl -in_file &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot; -install_dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALL_DIR</span> <span class="o">+</span> <span class="s">&quot; -paired_end &quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;perl &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span> <span class="o">+</span> <span class="s">&quot;pre_assemble.pl -in_file &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">+</span> <span class="s">&quot; -install_dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">INSTALL_DIR</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="ReadNormProcess.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.ReadNormProcess.run">[docs]</a>        <span class="c">#parse the process args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>
        <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">paired_end</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;paired_end&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">paired_end</span> <span class="o">=</span> <span class="bp">True</span>

        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Normalizing with khmer.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">run_khmer</span><span class="p">()</span>


<span class="k">class</span> <span class="nc">HPCJob</span><span class="p">(</span><span class="n">Job</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="HPCJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob">[docs]</a>
    <span class="n">sshRetries</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">location</span> <span class="o">=</span> <span class="n">Locations</span><span class="o">.</span><span class="n">HPC</span>
    <span class="n">mem_increment</span> <span class="o">=</span> <span class="mi">200</span>
    <span class="n">retry_interval</span> <span class="o">=</span> <span class="mi">30</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">process_args</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">):</span>
        <span class="n">Job</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_increment</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">mem_increment</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_cpu4_ppn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adjust_mem4_ppn</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_resourceStr</span> <span class="o">=</span> <span class="n">resources</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">hpc_cred</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailCredentials</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">mail_cred</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">location</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">location</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">remote_dir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">runName</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retryInterval</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">retry_interval</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">restart</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">restart_jobs</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailEnabled</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_handle_args</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_adjust_cpu4_ppn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;cpu&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_adjust_mem4_ppn</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;mb&quot;</span><span class="p">,</span> <span class="s">&quot;&quot;</span><span class="p">)</span>
        <span class="n">mem</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;mb&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mem_increment</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_increment</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">_cleanupLocalFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c">#call each qsub job&#39;s cleanup</span>
        <span class="k">for</span> <span class="n">qsub</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="n">qsub</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_removeWorkingDirectory</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">connection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">()</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;rm -r &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span>
        <span class="n">connection</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span><span class="s">&quot;mem&quot;</span><span class="p">:</span> <span class="s">&quot;500mb&quot;</span><span class="p">,</span> <span class="s">&quot;wall&quot;</span><span class="p">:</span> <span class="s">&quot;24:00:00&quot;</span><span class="p">,</span> <span class="s">&quot;ppn&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;cpu&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;nodesPerSubJob&quot;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span> <span class="s">&quot;queue&quot;</span><span class="p">:</span> <span class="s">&quot;bio&quot;</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_disableMail</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Error accessing mail account after &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">HPCJob</span><span class="o">.</span><span class="n">sshRetries</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; retries, disabling mail checking for: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobName</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;/n&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailEnabled</span> <span class="o">=</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_mailConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">sshRetries</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailEnabled</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mailConnect</span> <span class="o">=</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4_SSL</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mailCredentials</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="s">&#39;993&#39;</span><span class="p">)</span>
                <span class="n">mailConnect</span><span class="o">.</span><span class="n">login</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mailCredentials</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailCredentials</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span>
                <span class="n">mailConnect</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">checkedMailbox</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">mailConnect</span>
            <span class="k">except</span> <span class="n">imaplib</span><span class="o">.</span><span class="n">IMAP4_SSL</span><span class="o">.</span><span class="n">abort</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;IMAP abort exception</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retryInterval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_disableMail</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">None</span>
            <span class="k">except</span> <span class="n">ssl</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;SSLError exception!</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
                    <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retryInterval</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_disableMail</span><span class="p">()</span>
                    <span class="k">return</span> <span class="bp">None</span>

        <span class="k">return</span> <span class="bp">None</span>

    <span class="k">def</span> <span class="nf">_sshConnect</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">retries</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
            <span class="n">retries</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">sshRetries</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="k">return</span> <span class="n">netutils</span><span class="o">.</span><span class="n">SSHConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error creating SSHConnection, sleeping for two minutes and trying again.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">120</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">(</span><span class="n">retries</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span>

    <span class="k">def</span> <span class="nf">_exceededMemory</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="n">retries</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">sshRetries</span>
        <span class="k">while</span><span class="p">(</span><span class="bp">True</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailEnabled</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">typ</span><span class="p">,</span> <span class="n">msg_ids</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="s">&#39;(SUBJECT &quot;PBS JOB &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">job</span><span class="o">.</span><span class="n">jobID</span><span class="p">)</span> <span class="o">+</span> <span class="s">&#39;&quot; BODY &quot;exceeded MEM usage hard limit&quot;)&#39;</span><span class="p">)</span>
                <span class="k">if</span><span class="p">(</span><span class="n">typ</span> <span class="o">==</span> <span class="s">&quot;OK&quot;</span><span class="p">):</span>
                    <span class="k">if</span><span class="p">(</span><span class="n">msg_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="s">&#39;&#39;</span><span class="p">):</span>
                        <span class="n">typ</span><span class="p">,</span> <span class="n">data</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span><span class="o">.</span><span class="n">fetch</span><span class="p">(</span><span class="n">msg_ids</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="s">&#39;(BODY.PEEK[TEXT])&#39;</span><span class="p">)</span>
                        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_parseEmailBody</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="s">&quot;mem&quot;</span><span class="p">))</span>
                <span class="k">return</span> <span class="mi">0</span>

            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="n">retries</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
                    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Exception raised during mail access!&quot;</span><span class="p">)</span>
                    <span class="n">retries</span> <span class="o">-=</span> <span class="mi">1</span>
                    <span class="c">#sleep, then start a new connection to mail server</span>
                    <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">retryInterval</span> <span class="o">*</span> <span class="mi">5</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mailConnect</span><span class="p">()</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">checkedMailbox</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">disableMail</span><span class="p">()</span>
                    <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_exitWithError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">job</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">False</span>

    <span class="k">def</span> <span class="nf">_parseEmailBody</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">directive</span><span class="p">):</span>
        <span class="k">if</span><span class="p">(</span><span class="n">directive</span> <span class="o">==</span> <span class="s">&quot;mem&quot;</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">response_part</span> <span class="ow">in</span> <span class="n">response</span><span class="p">:</span>
                <span class="k">if</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">response_part</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                    <span class="n">text</span> <span class="o">=</span> <span class="n">response_part</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">it</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">text</span><span class="o">.</span><span class="n">splitlines</span><span class="p">())</span>
                    <span class="c">#iterate over the email text</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">it</span><span class="p">:</span>
                        <span class="c">#if this is the memory usage line, parse memory usage</span>
                        <span class="k">if</span><span class="p">(</span><span class="s">&quot;exceeded MEM usage hard limit&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                            <span class="k">return</span> <span class="n">line</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;(&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;&gt;&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="k">return</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">checkIndividualJob</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">jobIndex</span><span class="p">):</span>
<div class="viewcode-block" id="HPCJob.checkIndividualJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.checkIndividualJob">[docs]</a>        <span class="n">proc</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">[</span><span class="n">jobIndex</span><span class="p">]</span>
        <span class="c">#check if this job terminated due to exeeding memory requests</span>
        <span class="n">exceeded</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exceededMemory</span><span class="p">(</span><span class="n">proc</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="n">exceeded</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;exceedMem&quot;</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">):</span>
                <span class="c">#set the new memory request to the amount used when the job was killed</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">memReq</span> <span class="o">=</span> <span class="n">exceeded</span>
            <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">status</span>

        <span class="c">#check if this job exited with an error status ######IMPLEMENT THIS##############</span>
        <span class="k">elif</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_exitWithError</span><span class="p">(</span><span class="n">proc</span><span class="p">)):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span>
            <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">status</span>

        <span class="n">command</span> <span class="o">=</span>  <span class="s">&quot;qstat -u mcitar | grep -c &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">jobID</span><span class="p">[:</span><span class="mi">16</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">running</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="c">#if we get to this section of code, grep has failed and we have no way of knowing anything about the process, abandon it</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error retrieving status of running job &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; - abandoning.</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">running</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">if</span><span class="p">(</span><span class="n">running</span> <span class="o">==</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;finished&quot;</span>
        <span class="k">elif</span><span class="p">(</span><span class="n">running</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;running&quot;</span>

        <span class="k">return</span> <span class="n">proc</span><span class="o">.</span><span class="n">status</span>

    <span class="k">def</span> <span class="nf">check</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">conn</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span></div>
<div class="viewcode-block" id="HPCJob.check"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.check">[docs]</a>        <span class="c">#create connections for the mailServer and reomte client for this check</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mailConnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">()</span>
        <span class="n">numFinished</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">errors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">proc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">):</span>
            <span class="n">stat</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">checkIndividualJob</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="s">&#39;finished&#39;</span><span class="p">):</span>
                <span class="n">proc</span><span class="o">.</span><span class="n">finishedCount</span> <span class="o">+=</span> <span class="mi">1</span>
                <span class="c">#give error messages time to reach the mail server</span>
                <span class="k">if</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">finishedCount</span> <span class="o">*</span> <span class="n">settings</span><span class="o">.</span><span class="n">mainLoopSleepInterval</span> <span class="o">&gt;=</span> <span class="n">settings</span><span class="o">.</span><span class="n">waitBeforeMarkComplete</span><span class="p">):</span>
                    <span class="n">numFinished</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span><span class="s">&quot;processed&quot;</span>

            <span class="k">elif</span><span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="s">&#39;exceedMem&#39;</span><span class="p">):</span>
                <span class="c">#check if we should restart this job</span>
                <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">restart</span><span class="p">):</span>
                    <span class="k">print</span><span class="p">(</span><span class="s">&quot;Job &quot;</span> <span class="o">+</span> <span class="n">proc</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot; exceeded its memory allowance, restarting with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">memReq</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_increment</span><span class="p">))</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">resubmit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mem_increment</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">numFinished</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="n">proc</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;error&quot;</span>
            <span class="k">elif</span><span class="p">(</span><span class="n">stat</span> <span class="o">==</span> <span class="s">&quot;error&quot;</span><span class="p">):</span>
                <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="n">index</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">errors</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mailConnect</span><span class="o">.</span><span class="n">logout</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

        <span class="k">if</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">)</span> <span class="o">==</span> <span class="n">numFinished</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">FINISHED</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">JobState</span><span class="o">.</span><span class="n">RUNNING</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="HPCJob.cleanup"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.cleanup">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">_cleanupLocalFiles</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_removeWorkingDirectory</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="HPCJob.complete"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.complete">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">upload</span><span class="p">()</span>
        <span class="c">#retrieve the output files</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">retrieveOutput</span><span class="p">()</span>
        <span class="c">#perform the normal complete actions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cleanup</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">retrieveOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="HPCJob.retrieveOutput"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.retrieveOutput">[docs]</a>        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">()</span>
        <span class="c">#iterate over the processes that are a part of this job, getting their outputs</span>
        <span class="k">for</span> <span class="n">proc</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="p">:</span>
            <span class="n">singleFile</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">retrieveOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">singleFile</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="k">print</span><span class="p">(</span><span class="n">singleFile</span><span class="p">)</span>
                <span class="n">tmp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">singleFile</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
                <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">tmp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">singleFile</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remoteConnect</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="HPCJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.start">[docs]</a>        <span class="k">print</span><span class="p">(</span><span class="s">&quot;Starting job: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_inputExists</span><span class="p">()):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Input file missing for job: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span> <span class="o">+</span> <span class="s">&quot;, aborting.&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c">#get the input file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filenames</span> <span class="o">=</span> <span class="n">splitInput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;cpu&#39;</span><span class="p">])</span>
        <span class="c">#open ssh connection</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">netutils</span><span class="o">.</span><span class="n">SSHConnection</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">host</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">user</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">sshCredentials</span><span class="o">.</span><span class="n">passwd</span><span class="p">)</span>
        <span class="n">working_dir</span><span class="p">,</span> <span class="n">discard</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="n">working_dir</span> <span class="o">+=</span> <span class="s">&quot;/&quot;</span>
        <span class="c">#make the remote directory for this job</span>
        <span class="n">makeRemoteDirectory</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filenames</span><span class="p">):</span>
            <span class="n">jobNo</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="n">jobName</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobName</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">jobNo</span><span class="p">)</span>
            <span class="c">#split the query file into directory, filename</span>
            <span class="c">#substitute the input and output files for this command</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span>

            <span class="c">#check if this job is sending output to a file, or to stdout</span>
            <span class="k">if</span><span class="p">(</span><span class="s">&quot;&lt;output&gt;&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="ow">or</span> <span class="s">&quot;&lt;output_hpc&gt;&quot;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span><span class="p">):</span>
                <span class="n">qsub</span> <span class="o">=</span> <span class="n">Qsub</span><span class="p">(</span><span class="n">jobName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="n">f</span><span class="p">,</span> <span class="n">jobName</span> <span class="o">+</span> <span class="n">FileExtensions</span><span class="o">.</span><span class="n">forProgramOutput</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">qsub</span> <span class="o">=</span> <span class="n">Qsub</span><span class="p">(</span><span class="n">jobName</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="n">f</span><span class="p">)</span>

            <span class="n">qsub</span><span class="o">.</span><span class="n">createPBSHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;queue&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;nodesPerSubJob&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">],</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_ACCOUNT</span> <span class="o">+</span> <span class="s">&quot;@&quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">MAIL_PROVIDER</span><span class="p">)</span>
            <span class="n">qsub</span><span class="o">.</span><span class="n">appendQsubCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;modules&#39;</span><span class="p">])</span>
            <span class="n">qsub</span><span class="o">.</span><span class="n">appendQsubCommand</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span><span class="p">)</span>
            <span class="n">qsub</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">processes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">qsub</span><span class="p">)</span>

        <span class="n">c</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span><span class="k">pass</span></div>
<div class="viewcode-block" id="HPCJob.stop"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.HPCJob.stop">[docs]</a>

<span class="k">class</span> <span class="nc">BlastJob</span><span class="p">(</span><span class="n">HPCJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="BlastJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">+=</span> <span class="s">&quot; -num_threads &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;500mb&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;24:00:00&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;modules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;module load ncbi_blast&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="k">return</span> <span class="n">ret</span>


<span class="k">class</span> <span class="nc">BlastJobNR</span><span class="p">(</span><span class="n">BlastJob</span><span class="p">):</span></div>
<div class="viewcode-block" id="BlastJobNR"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastJobNR">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">BlastJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">+=</span> <span class="s">&quot; -db nr&quot;</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">BlastJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;5000mb&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;192:00:00&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>

<span class="k">class</span> <span class="nc">BlastJobSwissprot</span><span class="p">(</span><span class="n">BlastJob</span><span class="p">):</span></div>
<div class="viewcode-block" id="BlastJobSwissprot"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlastJobSwissprot">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">BlastJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">+=</span> <span class="s">&quot; -db swissprot&quot;</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">BlastJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;mem&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;1000mb&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;48:00:00&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>

<span class="k">class</span> <span class="nc">BlatJob</span><span class="p">(</span><span class="n">HPCJob</span><span class="p">):</span></div>
<div class="viewcode-block" id="BlatJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlatJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;86:00:00&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;modules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;module load blat&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">determineMemRequirement</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
<div class="viewcode-block" id="BlatJob.determineMemRequirement"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.BlatJob.determineMemRequirement">[docs]</a>        <span class="c">#get the size of database file in the parameters</span>
        <span class="k">pass</span>


<span class="k">class</span> <span class="nc">PfamJob</span><span class="p">(</span><span class="n">HPCJob</span><span class="p">,</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="PfamJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PfamJob">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">):</span>
        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">jobType</span><span class="p">,</span> <span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executable</span> <span class="o">=</span> <span class="s">&quot;pfam_scan.pl&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">arg_string</span> <span class="o">=</span> <span class="s">&quot; -dir &quot;</span> <span class="o">+</span> <span class="n">settings</span><span class="o">.</span><span class="n">pfam_data_path</span> <span class="o">+</span> <span class="s">&quot; -cpu &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&quot;ppn&quot;</span><span class="p">])</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">process_args</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">parse</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">ret</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;48:00:00&quot;</span>
        <span class="n">ret</span><span class="p">[</span><span class="s">&#39;modules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;module load hmmer&quot;</span>
        <span class="k">return</span> <span class="n">ret</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="PfamJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PfamJob.start">[docs]</a>        <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">join</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="PfamJob.run"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.PfamJob.run">[docs]</a>        <span class="c">#check if we need to translate the input</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;translate&quot;</span><span class="p">)):</span>
            <span class="k">print</span><span class="p">(</span><span class="s">&quot;Translating pfam input file.&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="n">translateSequenceFile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">,</span> <span class="s">&quot;fasta&quot;</span><span class="p">)</span>

        <span class="n">HPCJob</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">QuantificationJob</span><span class="p">(</span><span class="n">HPCJob</span><span class="p">):</span></div></div>
<div class="viewcode-block" id="QuantificationJob"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob">[docs]</a>
    <span class="k">class</span> <span class="nc">QTypes</span><span class="p">:</span>
<div class="viewcode-block" id="QuantificationJob.QTypes"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.QTypes">[docs]</a>
        <span class="n">BLAST</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">BOWTIE</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">types</span> <span class="o">=</span> <span class="p">[</span><span class="n">BLAST</span><span class="p">,</span> <span class="n">BOWTIE</span><span class="p">]</span>

    <span class="c">#def __init__(self, projectName, jobName, t, executable = &quot;NA&quot;, resources = {}, pipeline_args = &quot;&quot;, process_args = &quot;&quot;):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">executable</span> <span class="o">=</span> <span class="s">&quot;NA&quot;</span><span class="p">,</span> <span class="n">resources</span> <span class="o">=</span> <span class="p">{},</span> <span class="n">pipeline_args</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">process_args</span> <span class="o">=</span> <span class="s">&quot;&quot;</span> <span class="p">):</span></div>
        <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pid</span><span class="p">,</span> <span class="n">jid</span><span class="p">,</span> <span class="n">t</span><span class="p">,</span> <span class="n">executable</span><span class="o">=</span><span class="n">executable</span><span class="p">,</span> <span class="n">resources</span><span class="o">=</span><span class="n">resources</span><span class="p">,</span> <span class="n">pipeline_args</span><span class="o">=</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="n">process_args</span><span class="o">=</span><span class="n">process_args</span><span class="p">)</span>
        <span class="c">#check if we have a fastq or fastq file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_quant_type</span> <span class="o">=</span> <span class="p">{</span><span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BLAST</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_blast</span><span class="p">,</span> <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BOWTIE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">complete_bowtie</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aligner_modules</span> <span class="o">=</span> <span class="p">{</span><span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BLAST</span><span class="p">:</span> <span class="s">&quot;module load ncbi_blast&quot;</span><span class="p">,</span>
                                <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BOWTIE</span><span class="p">:</span> <span class="s">&quot;module load bowtie&quot;</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_aln</span> <span class="o">=</span> <span class="p">{</span><span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BLAST</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_blast</span><span class="p">,</span> <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BOWTIE</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">prep_bowtie</span><span class="p">}</span>

    <span class="k">def</span> <span class="nf">_cleanupLocalFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">f</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">f</span><span class="p">)):</span>
                <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">_cleanupLocalFiles</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">resources</span> <span class="o">=</span> <span class="n">HPCJob</span><span class="o">.</span><span class="n">_defaultResources</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">resources</span><span class="p">[</span><span class="s">&#39;ppn&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">4</span>
        <span class="n">resources</span><span class="p">[</span><span class="s">&#39;wall&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s">&quot;24:00:00&quot;</span>
        <span class="k">return</span> <span class="n">resources</span>

    <span class="k">def</span> <span class="nf">_handle_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">Job</span><span class="o">.</span><span class="n">_handle_args</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">db_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">db_type</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="p">,</span> <span class="s">&quot;input_file&quot;</span><span class="p">)):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">input_file</span>

        <span class="n">BLAST_TYPE</span> <span class="o">=</span> <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BLAST</span>
        <span class="n">BOWTIE_TYPE</span> <span class="o">=</span> <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BOWTIE</span>
        <span class="n">aligner</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">aligner</span>

        <span class="k">if</span><span class="p">(</span><span class="s">&#39;blast&#39;</span> <span class="ow">in</span> <span class="n">aligner</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span> <span class="o">=</span> <span class="n">BLAST_TYPE</span>

        <span class="k">elif</span><span class="p">(</span><span class="n">aligner</span> <span class="o">==</span> <span class="s">&#39;bowtie&#39;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span> <span class="o">=</span> <span class="n">BOWTIE_TYPE</span>

        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">db</span><span class="p">)):</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span> <span class="o">!=</span> <span class="n">BLAST_TYPE</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;_project.fasta&quot;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;.fasta&quot;</span>
                <span class="c">#add code to check if fastq file exists, and if so convert</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">db</span>
            <span class="n">discard</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span><span class="p">)</span>

        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">query</span><span class="p">)):</span>
            <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span> <span class="o">!=</span> <span class="n">BLAST_TYPE</span><span class="p">):</span>
                <span class="n">bowtie_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;.fastq&quot;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">bowtie_path</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span><span class="p">[</span><span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BOWTIE</span><span class="p">]</span> <span class="o">=</span> <span class="n">bowtie_path</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">blast_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">pn</span> <span class="o">+</span> <span class="s">&quot;_project.fasta&quot;</span>
                <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">blast_path</span><span class="p">)):</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span><span class="p">[</span><span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">BLAST</span><span class="p">]</span> <span class="o">=</span> <span class="n">blast_path</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">QuantificationJob</span><span class="o">.</span><span class="n">QTypes</span><span class="o">.</span><span class="n">types</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span><span class="p">[</span><span class="n">t</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">query</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">remote_db_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">db</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remote_db_path</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span><span class="p">]</span>
        <span class="n">base</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process_args</span><span class="o">.</span><span class="n">query</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="n">fn</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<div class="viewcode-block" id="QuantificationJob.complete"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.complete">[docs]</a>        <span class="n">HPCJob</span><span class="o">.</span><span class="n">complete</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complete_quant_type</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span><span class="p">]()</span>

    <span class="k">def</span> <span class="nf">complete_blast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.complete_blast"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.complete_blast">[docs]</a>        <span class="n">tmp</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="s">&quot;tmp_quant.txt&quot;</span>
        <span class="n">shutil</span><span class="o">.</span><span class="n">move</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="n">tmp</span><span class="p">)</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="s">&quot;python &quot;</span><span class="p">,</span> <span class="n">settings</span><span class="o">.</span><span class="n">SCRIPTPATH</span><span class="p">,</span> <span class="s">&quot;seqtools.py -at blast-tab -ft fasta -f &quot;</span><span class="p">,</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">query_files</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span><span class="p">],</span> <span class="s">&quot; -a &quot;</span><span class="p">,</span> <span class="n">tmp</span><span class="p">,</span> <span class="s">&quot; --quantification &quot;</span><span class="p">,</span>
                        <span class="s">&quot;&gt; &quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_executeCmd</span><span class="p">(</span><span class="n">cmd</span><span class="p">)</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">complete_bowtie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.complete_bowtie"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.complete_bowtie">[docs]</a>        <span class="c">#move the quantification file</span>
        <span class="n">tmp_quant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="s">&quot;quant_tmp.txt&quot;</span>
        <span class="c">#change this to use shutil</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;mv &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="n">tmp_quant</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="n">proc</span><span class="o">.</span><span class="n">wait</span><span class="p">()</span>
        <span class="c">#open the temporary quantification file</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">fh</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">tmp_quant</span><span class="p">,</span> <span class="s">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;@&quot;</span><span class="p">)):</span>
               <span class="k">continue</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">make_record</span><span class="p">(</span><span class="n">line</span><span class="p">,</span> <span class="s">&quot;sam&quot;</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">r</span><span class="o">.</span><span class="n">reference</span> <span class="ow">in</span> <span class="n">results</span><span class="p">):</span>
                <span class="n">results</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">results</span><span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">reference</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="n">fh</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">reference</span><span class="p">,</span> <span class="n">records</span> <span class="ow">in</span> <span class="n">results</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">reference</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\t</span><span class="s">&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">records</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>

        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tmp_quant</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">move_db_files</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.move_db_files"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.move_db_files">[docs]</a>        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">()</span>
        <span class="n">makeRemoteDirectory</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">runName</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">fp</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">fp</span><span class="p">)):</span>
                <span class="n">d</span><span class="p">,</span> <span class="n">fn</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">fp</span><span class="p">)</span>
                <span class="n">c</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="n">fn</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prep_blast</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.prep_blast"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.prep_blast">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span><span class="p">]</span>
        <span class="c">#add a directive to make the wu-blast database</span>
        <span class="c">#self.hpc_command = &quot;&quot;.join([&quot;xdformat &quot;, file_io.wu_blast_typeflags[self.db_type],</span>
        <span class="c">#                                &quot; -o &quot;, self.remote_db_path, &quot; &quot;,</span>
        <span class="c">#                                self.remote_db_path, &quot;\n&quot;])</span>

        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">db_type</span> <span class="o">==</span> <span class="s">&quot;NT&quot;</span><span class="p">):</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.nin&#39;</span><span class="p">,</span> <span class="s">&#39;.nsq&#39;</span><span class="p">,</span> <span class="s">&#39;.nhr&#39;</span><span class="p">]</span>
            <span class="c">#self.db_files.append(self.local_db_path + &quot;.nin&quot;)</span>
            <span class="c">#self.db_files.append(self.local_db_path + &quot;.nsq&quot;)</span>
            <span class="c">#self.db_files.append(self.local_db_path + &quot;.nhr&quot;)</span>
            <span class="c"># blast_files = [(self.db_file + &quot;.nin&quot;), (self.db_file + &quot;.nsq&quot;), + (self.db_file + &quot;.nhr&quot;)]</span>
        <span class="c">#    self.db_files.extend(blast_files)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">exts</span> <span class="o">=</span> <span class="p">[</span><span class="s">&#39;.pin&#39;</span><span class="p">,</span> <span class="s">&#39;.psq&#39;</span><span class="p">,</span> <span class="s">&#39;.phr&#39;</span><span class="p">]</span>

        <span class="k">for</span> <span class="n">ext</span> <span class="ow">in</span> <span class="n">exts</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span> <span class="o">+</span> <span class="n">ext</span><span class="p">)</span>

        <span class="n">make_blast_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">db_type</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">prep_bowtie</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.prep_bowtie"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.prep_bowtie">[docs]</a>        <span class="c">#make and move the bowtie index</span>
        <span class="n">make_bowtie_index</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">local_db_path</span><span class="p">)</span>
        <span class="c">#get the list of all bowtie indicies</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s">&quot;ls &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="s">&#39; | grep -e &quot;.ebwt$&quot;&#39;</span><span class="p">,</span>
                                <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
        <span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">err</span><span class="p">)</span> <span class="o">=</span> <span class="n">proc</span><span class="o">.</span><span class="n">communicate</span><span class="p">()</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="c">#make the remote directory</span>
        <span class="n">c</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sshConnect</span><span class="p">()</span>
        <span class="n">makeRemoteDirectory</span><span class="p">(</span><span class="n">settings</span><span class="o">.</span><span class="n">remote_dir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">runName</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">out</span><span class="p">:</span>
            <span class="k">if</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="s">&quot;.ebwt&quot;</span> <span class="ow">in</span> <span class="n">line</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="n">line</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="n">local</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="n">line</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">db_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">local</span><span class="p">)</span>
            <span class="k">if</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">local</span><span class="p">)):</span>
                <span class="n">c</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">local</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="n">line</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="QuantificationJob.start"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.QuantificationJob.start">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">prepare_for_aln</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span><span class="p">]()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">move_db_files</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resources</span><span class="p">[</span><span class="s">&#39;modules&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">aligner_modules</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">quant_type</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hpc_command</span> <span class="o">+=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_prepare_cmd</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline_args</span><span class="o">.</span><span class="n">aligner</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">jobType</span><span class="p">)</span>
        <span class="n">HPCJob</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">Qsub</span><span class="p">:</span></div></div>
<div class="viewcode-block" id="Qsub"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub">[docs]</a>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="n">inputFile</span><span class="p">,</span> <span class="n">outputFile</span> <span class="o">=</span> <span class="bp">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="n">n</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memReq</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppn</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="s">&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localFilename</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">inputFile</span><span class="p">)</span>
        <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">==</span> <span class="s">&quot;&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">=</span> <span class="s">&quot;./&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteInput</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">localFilename</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="n">d</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;idle&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finishedCount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">outputFile</span> <span class="o">==</span> <span class="bp">None</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.stdout&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">=</span> <span class="n">outputFile</span>


    <span class="k">def</span> <span class="nf">_getConnection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">h</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">p</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">netutils</span><span class="o">.</span><span class="n">SSHConnection</span><span class="p">(</span><span class="n">h</span><span class="p">,</span> <span class="n">username</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="n">p</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">appendQsubCommand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command</span><span class="p">):</span>
<div class="viewcode-block" id="Qsub.appendQsubCommand"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.appendQsubCommand">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">+=</span> <span class="n">command</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">appendToPBS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directive</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.appendToPBS"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.appendToPBS">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="n">directive</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>

    <span class="k">def</span> <span class="nf">cleanup</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.cleanup"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.cleanup">[docs]</a>        <span class="k">try</span><span class="p">:</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.qsub&quot;</span><span class="p">)</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">localFilename</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">createPBSHeader</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">walltime</span><span class="p">,</span> <span class="n">q</span><span class="p">,</span> <span class="n">mem</span><span class="p">,</span> <span class="n">nodes</span><span class="p">,</span> <span class="n">ppn</span><span class="p">,</span> <span class="n">email</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.createPBSHeader"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.createPBSHeader">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">=</span> <span class="s">&quot;#! /bin/bash</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -r n</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -N &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -o &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.stdout</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -e &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.stderr</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="n">q</span> <span class="o">==</span> <span class="s">&#39;billed&#39;</span><span class="p">):</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -W group_list=billed</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="k">else</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -q &quot;</span> <span class="o">+</span> <span class="n">q</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -m a</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -M &quot;</span> <span class="o">+</span> <span class="n">email</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -l walltime=&quot;</span> <span class="o">+</span> <span class="n">walltime</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -l pmem=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">mem</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;#PBS -l nodes=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">nodes</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;:ppn=&quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">ppn</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">qsub</span> <span class="o">+=</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">memReq</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mem</span><span class="p">[:</span><span class="o">-</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">walltime</span> <span class="o">=</span> <span class="n">walltime</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">email</span> <span class="o">=</span> <span class="n">email</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">q</span> <span class="o">=</span> <span class="n">q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ppn</span> <span class="o">=</span> <span class="n">ppn</span>

    <span class="k">def</span> <span class="nf">retrieveOutput</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.retrieveOutput"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.retrieveOutput">[docs]</a>        <span class="c">#gets the output created by this Qsub job, returns the local path to the file</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Retrieving: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span> <span class="o">+</span> <span class="s">&quot; &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
            <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s">&quot;Error &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">errno</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot; retrieving: &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>  <span class="o">+</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span>

    <span class="k">def</span> <span class="nf">resubmit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="n">memIncrease</span> <span class="o">=</span> <span class="mi">0</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.resubmit"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.resubmit">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">createPBSHeader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">walltime</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">q</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">memReq</span> <span class="o">+</span> <span class="n">memIncrease</span><span class="p">)</span> <span class="o">+</span> <span class="s">&quot;mb&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">nodes</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ppn</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">setDir</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.setDir"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.setDir">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">=</span> <span class="n">directory</span>

    <span class="k">def</span> <span class="nf">setMemRequest</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">req</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.setMemRequest"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.setMemRequest">[docs]</a>        <span class="bp">self</span><span class="o">.</span><span class="n">memReq</span> <span class="o">=</span> <span class="n">req</span>

    <span class="k">def</span> <span class="nf">submit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">c</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.submit"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.submit">[docs]</a>        <span class="c">#replace the input and output in the command</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;input&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteInput</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;output&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="c">#replace for new-style job classes using _prepare_cmd in conjunction with the executables table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">commands</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;input_hpc&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteInput</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s">&quot;&lt;output_hpc&gt;&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputFile</span><span class="p">)</span>
        <span class="c">#write the qsub submit file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeQsub</span><span class="p">()</span>
        <span class="c">#put this qsub script on the server</span>
        <span class="n">c</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.qsub&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.qsub&quot;</span><span class="p">)</span>
        <span class="c">#put input files on the server</span>
        <span class="n">c</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">localFilename</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;/&quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteInput</span><span class="p">)</span>
        <span class="c">#remove the temporary qsub file</span>
        <span class="c">#os.remove(self.name + &quot;.qsub&quot;)</span>
        <span class="c">#remove the temporary input file</span>
        <span class="c">#os.remove(self.inputFile)</span>
        <span class="c">#start the job</span>
        <span class="n">command</span> <span class="o">=</span> <span class="s">&quot;cd &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">remoteDir</span> <span class="o">+</span> <span class="s">&quot;;&quot;</span>
        <span class="n">command</span> <span class="o">+=</span> <span class="s">&quot;qsub &quot;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.qsub&quot;</span>
        <span class="n">jobID</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="n">command</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jobID</span> <span class="o">=</span> <span class="n">jobID</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">status</span> <span class="o">=</span> <span class="s">&quot;running&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">finishedCount</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">writeQsub</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></div>
<div class="viewcode-block" id="Qsub.writeQsub"><a class="viewcode-back" href="../../zeroclick.html#zeroclick.jobs.Qsub.writeQsub">[docs]</a>        <span class="n">out</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">localDir</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span> <span class="o">+</span> <span class="s">&quot;.qsub&quot;</span><span class="p">,</span> <span class="s">&#39;w&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qsub</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">commands</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div></div></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none">
  <h3>Quick search</h3>
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="../../py-modindex.html" title="Python Module Index"
             >modules</a> |</li>
        <li><a href="../../index.html">zeroclick  documentation</a> &raquo;</li>
          <li><a href="../index.html" >Module code</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
        &copy; Copyright 2013, Author.
      Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.1.3.
    </div>
  </body>
</html>